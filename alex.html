<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alex Synth</title>
<style>
  body { margin:0; height:100%; background: black; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif; transition: background 1s linear; }
  #name { font-size:8vw; font-weight:bold; transition: color 0.3s; }
  .keyboard { display:flex; flex-wrap:wrap; max-width:800px; margin-top:20px; }
  .key { flex:1 0 60px; margin:5px; padding:20px; background:#222; border-radius:8px; text-align:center; cursor:pointer; user-select:none; color:white; }
  .key.active { background:#555; }
</style>
</head>
<body>
<div id="name"></div>
<div class="keyboard" id="keyboard-low" aria-label="Lower octave (C3–B3)"></div>
  <div class="keyboard" id="keyboard-high" aria-label="Upper range (C4–F5)"></div>
<script>
    // --- Config ---
    const WAVE_TYPES = ['sine','square','sawtooth','triangle'];
    let currentWave = 0; // 0..3

    // Envelope settings (seconds)
    const ADSR = { attack: 0.01, decay: 0.08, sustain: 0.75, release: 0.15 };

    // Color cycling state
    let hue = 210; // starting hue
    function updateTheme(h){
      const h1 = h % 360;
      const h2 = (h + 180) % 360;
      document.documentElement.style.setProperty('--accent', `hsl(${h1} 90% 70%)`);
      document.documentElement.style.setProperty('--accent-2', `hsl(${h2} 90% 62%)`);
      // Refresh background with related hues
      document.body.style.background =
        `radial-gradient(1200px 800px at 20% -10%, hsl(${(h1+220)%360} 35% 16%) 0, transparent 60%),`+
        `radial-gradient(900px 600px at 120% 110%, hsl(${(h1+260)%360} 32% 12%) 0, transparent 60%),`+
        `var(--bg)`;
    }

    // Utility: build white-key diatonic set starting at given MIDI C
    const WHITE_OFFSETS = [0,2,4,5,7,9,11];
    function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }
    const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    function midiToLabel(m){ const n = m % 12, o = Math.floor(m/12) - 1; return `${NOTE_NAMES[n]}${o}`; }

    // Build mappings
    const lowerKeys = ['z','x','c','v','b','n','m']; // C3..B3 (white keys)
    const upperKeys = ['a','s','d','f','g','h','j','k','l',';','\'']; // C4..F5 (white keys, extended)

    const KEY_TO_NOTE = {};
    // Lower octave base C3 = MIDI 48
    lowerKeys.forEach((k, i) => {
      const midi = 48 + WHITE_OFFSETS[i];
      KEY_TO_NOTE[k] = { label: midiToLabel(midi), freq: +(midiToFreq(midi).toFixed(2)) };
    });
    // Upper range base C4 = MIDI 60, extended diatonic degrees [0,2,4,5,7,9,11,12,14,16,17]
    const upperOffsets = [0,2,4,5,7,9,11,12,14,16,17];
    upperKeys.forEach((k, i) => {
      const midi = 60 + upperOffsets[i];
      KEY_TO_NOTE[k] = { label: midiToLabel(midi), freq: +(midiToFreq(midi).toFixed(2)) };
    });

    // State
    let audioCtx = null;
    const voices = new Map(); // key -> {osc, gain}

    const nameEl = document.getElementById('name');
    const lowEl = document.getElementById('keyboard-low');
    const highEl = document.getElementById('keyboard-high');

    // Build clickable pads (by rows)
    function makePad(container, key){
      const div = document.createElement('div');
      div.className = 'key';
      div.dataset.key = key;
      div.innerHTML = `<div style=\"font-size:22px\">${key.toUpperCase()}</div><small>${KEY_TO_NOTE[key].label}</small>`;
      container.appendChild(div);
      bindPadEvents(div);
    }
    lowerKeys.forEach(k => makePad(lowEl, k));
    upperKeys.forEach(k => makePad(highEl, k));

    function ensureCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function pulseNameColor(){
      nameEl.style.webkitTextStrokeColor = `hsl(${hue % 360} 90% 70%)`;
      nameEl.style.textShadow = `0 0 20px hsl(${hue % 360} 90% 60% / .35), 0 0 60px hsl(${(hue+180)%360} 90% 60% / .25)`;
    }

    function showName() {
      nameEl.classList.add('show');
      pulseNameColor();
    }
    function hideNameIfNoKeys() {
      if (voices.size === 0) nameEl.classList.remove('show');
    }

    function startNote(key) {
      const info = KEY_TO_NOTE[key];
      if (!info || voices.has(key)) return; // ignore unknown or held repeats
      ensureCtx();

      // Cycle theme for every new note
      hue = (hue + 22) % 360; // step through the wheel
      updateTheme(hue);
      pulseNameColor();

      // Nodes
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = WAVE_TYPES[currentWave];
      osc.frequency.value = info.freq;

      // Envelope
      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(1.0, now + ADSR.attack);
      gain.gain.linearRampToValueAtTime(ADSR.sustain, now + ADSR.attack + ADSR.decay);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start();

      voices.set(key, {osc, gain});

      document.querySelector(`.key[data-key=\"${CSS.escape(key)}\"]`)?.classList.add('active');
      showName();
    }

    function stopNote(key) {
      const voice = voices.get(key);
      if (!voice) return;
      const now = audioCtx.currentTime;
      const {osc, gain} = voice;
      gain.gain.cancelScheduledValues(now);
      gain.gain.setTargetAtTime(0.0001, now, ADSR.release / 3);
      setTimeout(() => {
        try { osc.stop(); } catch {}
        try { osc.disconnect(); gain.disconnect(); } catch {}
      }, Math.max(ADSR.release * 1000, 80));
      voices.delete(key);

      document.querySelector(`.key[data-key=\"${CSS.escape(key)}\"]`)?.classList.remove('active');
      hideNameIfNoKeys();
    }

    // Keyboard controls
    window.addEventListener('keydown', (e) => {
      const k = e.key.toLowerCase();
      if (k in KEY_TO_NOTE) {
        e.preventDefault();
        startNote(k);
      }
      // Waveform switchers: 1..4
      if (['1','2','3','4'].includes(k)) {
        currentWave = parseInt(k,10) - 1;
        // Visual nudge
        nameEl.style.transform = 'scale(1.03)';
        setTimeout(()=> nameEl.style.transform = '', 120);
      }
    });
    window.addEventListener('keyup', (e) => {
      const k = e.key.toLowerCase();
      if (k in KEY_TO_NOTE) {
        e.preventDefault();
        stopNote(k);
      }
    });

    // Mouse / touch for the on-screen pads
    function bindPadEvents(el){
      const key = el.dataset.key;
      const down = (ev)=>{ ev.preventDefault(); startNote(key); };
      const up = (ev)=>{ ev.preventDefault(); stopNote(key); };
      el.addEventListener('mousedown', down);
      el.addEventListener('touchstart', down, {passive:false});
      window.addEventListener('mouseup', up);
      window.addEventListener('touchend', up, {passive:false});
    }

    // Handle page visibility (stop stuck notes if tab loses focus)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        Array.from(voices.keys()).forEach(stopNote);
      }
    });

    // Initialize theme once
    updateTheme(hue);
  </script>
</body>
</html>
